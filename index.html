<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kalkulator Czyste Powietrze – ARKON</title>
<meta name="description" content="Kalkulator dotacji Czyste Powietrze 2025: pompa ciepła, ocieplenie, rekuperacja. Limity pojedyncze i pakietowe, VAT 8/23%, CSV, druk klient/sprzedawca, wysyłka e‑mailem.">
<style>
  :root{
    --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da;
    --accent:#4cc9f0; --ok:#2b8a57; --warn:#e6a700; --grid:#243059; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:auto;padding:24px 16px 130px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  .logo{width:54px;height:54px;border-radius:12px;display:grid;place-items:center;background:#0e1538;border:1px solid #1f2a55;color:var(--accent)}
  .logo svg{width:42px;height:42px}
  h1{font-size:22px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid #1c2750;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px #0006}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:repeat(2,1fr)}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,button,textarea{font:500 15px/1.2 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
  input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:10px;outline:none}
  textarea{min-height:70px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:#3b4fa0;box-shadow:0 0 0 3px #3b4fa033}
  input.num{text-align:right}
  button{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
  button.ghost{background:transparent;border:1px dashed #3a4ca3}
  button.ok{background:#194d34;border-color:var(--ok)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab-btn{background:#233261;border:1px solid #3a4ca3;border-radius:999px;padding:10px 14px}
  .tab-btn[aria-selected="true"]{background:#1b2550;border-color:#67a1ff;box-shadow:0 0 0 2px #67a1ff44}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:8px 10px;margin:4px 8px 0 0;font-size:13px;color:var(--muted)}
  .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .hidden{display:none}
  .warn{display:block;background:#2a2100;border:1px solid #6a5400;color:#ffefb0;border-radius:10px;padding:10px;margin-top:10px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--grid);text-align:left;vertical-align:middle}
  th.num,td.num{text-align:right}
  .cap-badge{display:inline-block;margin-left:8px;padding:2px 8px;border:1px solid #ff7b7b;border-radius:999px;font-size:11px;color:#ffdada;background:#3a0e14}
  .cap-prog{display:inline-block;margin-left:8px;padding:2px 8px;border:1px solid #ffd27b;border-radius:999px;font-size:11px;color:#fff2d2;background:#5a3a0e}
  .over-panel{box-shadow:0 0 0 2px #ff7b7b55 inset}
  .chip{display:inline-block;padding:6px 10px;border:1px solid #3750a8;border-radius:999px;background:#17224b;color:#bcd1ff;font-size:12px}
  .chip.warn{border-color:#8a6e00;background:#302400;color:#ffe9a8}
  .chip.danger{border-color:#9c2b2b;background:#2b1212;color:#ffd6d6}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
  .subnote{font-size:12px;color:#9fb2ff;margin-top:6px}
  @media(max-width:860px){
    .wrap{padding-bottom:160px}
    .hide-sm{display:none}
    th:nth-child(4),td:nth-child(4), /* Limit (aktywny) */
    th:nth-child(5),td:nth-child(5), /* Min. wydatek */
    th:nth-child(7),td:nth-child(7)  /* Koszt brutto */ {display:none}
  }
  @media print{
    body{background:#fff;color:#000}
    .tabs,.tab-btn,.login-overlay,.toolbar button,.right button{display:none!important}
    .panel{box-shadow:none;border:1px solid #bbb;background:#fff}
    .logo{border:0;box-shadow:none}
    .cap-badge,.cap-prog{border-color:#000;color:#000}
  }

  /* tryb drukowania dla klienta */
  .print-client .admin-only,
  .print-client #warnTop,
  .print-client .pill:has(#sumCapProg),
  .print-client .pill:has(#sumOverCap),
  .print-client .chip,
  .print-client .subnote { display:none !important; }
  .client-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .client-header .logo{width:64px;height:64px}
  .client-meta{font-size:12px;color:#333}
  .client-title{font-weight:800;margin:4px 0}
  .signs{display:flex;gap:40px;margin-top:28px}
  .sign{flex:1;border-top:1px solid #999;padding-top:6px;text-align:center;font-size:12px}

  /* login */
  .login-overlay{position:fixed;inset:0;background:radial-gradient(120% 120% at 20% 20%,#0c1230,#080c1e);display:grid;place-items:center;z-index:9999}
  .login-box{width:min(520px,92vw);background:#10183a;border:1px solid #263166;border-radius:14px;padding:22px;box-shadow:0 16px 48px #000b}
  .login-title{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .login-title .logo{width:48px;height:48px}
  .login-grid{display:grid;gap:10px;margin-top:10px}
</style>
</head>
<body>
<!-- LOGIN (UI; nie jest zabezpieczeniem serwerowym) -->
<div id="login" class="login-overlay" aria-modal="true" role="dialog" aria-labelledby="loginTitle">
  <div class="login-box">
    <div class="login-title">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" rx="18" fill="#0e1538"/><path d="M18 78 L60 22 L102 78" stroke="#4cc9f0" stroke-width="10" fill="none" stroke-linecap="round" stroke-linejoin="round"/><text x="60" y="96" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="28" font-weight="800" fill="#4cc9f0">ARKON</text></svg>
      </div>
      <div>
        <div id="loginTitle" style="font-weight:800">Panel dostępu • Arkon</div>
        <div class="muted">Wpisz nazwę i hasło, aby otworzyć kalkulator.</div>
      </div>
    </div>
    <div class="login-grid">
      <div>
        <label for="lgUser">Nazwa użytkownika</label>
        <input id="lgUser" placeholder="Arkon" autocomplete="username">
      </div>
      <div>
        <label for="lgPass">Hasło</label>
        <input id="lgPass" placeholder="Arkon2025" type="password" autocomplete="current-password">
      </div>
      <div class="right">
        <button id="btnLogin" class="ok" type="button">Zaloguj</button>
      </div>
      <div id="lgMsg" class="muted" aria-live="polite"></div>
    </div>
  </div>
</div>

<div class="wrap" id="app" style="filter:blur(4px);pointer-events:none">
  <header>
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" rx="18" fill="#0e1538"/><path d="M18 78 L60 22 L102 78" stroke="#4cc9f0" stroke-width="10" fill="none" stroke-linecap="round" stroke-linejoin="round"/><text x="60" y="96" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="28" font-weight="800" fill="#4cc9f0">ARKON</text></svg>
    </div>
    <div>
      <h1>Kalkulator dotacji • Czyste Powietrze 2025</h1>
      <div class="muted">Źródło ciepła + ocieplenie/stolarka. Limity pojedyncze i <b>pakietowe</b>, VAT 8/23%, zapis/CSV/druk, wysyłka oferty.</div>
    </div>
  </header>

  <div class="tabs admin-only" role="tablist" aria-label="Zakładki kalkulatora">
    <button class="tab-btn" role="tab" aria-selected="true" aria-controls="tab-main" id="tabbtn-main" type="button">Główne (Źródło ciepła)</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-env" id="tabbtn-env" type="button">Ocieplenie / Stolarka</button>
  </div>

  <!-- METRYCZKA / USTAWIENIA -->
  <section class="panel admin-only" aria-labelledby="metryczkaTitle">
    <h2 id="metryczkaTitle" class="muted" style="margin:0 0 8px 0">Metryczka i ustawienia</h2>
    <div class="grid cols-3">
      <div>
        <label for="typ">Typ gospodarstwa</label>
        <select id="typ"><option value="">— wybierz —</option><option>JEDNO</option><option>WIELO</option></select>
      </div>
      <div>
        <label for="doch_mies">Miesięczny dochód na osobę [zł]</label>
        <input id="doch_mies" inputmode="decimal" placeholder="np. 2100">
      </div>
      <div>
        <label for="doch_roczny">Roczny dochód wnioskodawcy [zł]</label>
        <input id="doch_roczny" inputmode="decimal" placeholder="np. 120000">
      </div>
      <div>
        <label for="swiadczenia">Świadczenia (MOPS/GOPS)</label>
        <select id="swiadczenia"><option value="">— wybierz —</option><option>TAK</option><option>NIE</option></select>
      </div>
      <div>
        <label for="euDemand">Zapotrzebowanie EU do ogrzewania (kWh/m²·rok)</label>
        <select id="euDemand">
          <option value="EU_BELOW_80">Poniżej 80</option>
          <option value="EU_80_140">80–140</option>
          <option value="EU_ABOVE_140">Powyżej 140</option>
        </select>
      </div>
      <div>
        <label for="vatSel">VAT dla obliczeń brutto</label>
        <select id="vatSel">
          <option value="0.08" selected>8% (budownictwo mieszkaniowe)</option>
          <option value="0.23">23% (inne)</option>
        </select>
      </div>
      <div class="pill">Poziom: <b id="poziom">—</b></div>
      <div class="pill">Procent: <b id="procent">—</b></div>
      <div class="pill">Źródło pakietu: <b id="catLabel">—</b></div>
      <div class="right">
        <button id="btnProfileP" class="ghost" type="button">Profil: Podstawowy / EU&gt;140</button>
        <button id="btnProfileM" class="ghost" type="button">Profil: Podwyższony / EU&gt;140</button>
        <button id="btnProfileT" class="ghost" type="button">Profil: Najwyższy / EU&gt;140</button>
      </div>
    </div>
    <div id="warnTop" class="warn hidden">
      Najwyższy poziom (100%) dla <b>PW+ / GRUNT</b> dostępny jest tylko dla EU <b>&gt; 140 kWh/m²·rok</b>. W innych przypadkach dotacja pakietowa T jest niedostępna (stosowane są wyłącznie limity pojedyncze).
    </div>
  </section>

  <!-- PODSUMOWANIE -->
  <section id="sumPanel" class="panel" aria-labelledby="sumTitle">
    <h2 id="sumTitle" class="muted" style="margin:0 0 8px 0">Podsumowanie</h2>
    <div aria-live="polite">
      <span class="pill">Wybrane (źródło): <b id="selCountMain">0</b></span>
      <span class="pill">Wybrane (ocieplenie): <b id="selCountEnv">0</b></span>
      <span class="pill admin-only">Suma dotacji (bez limitu): <b id="sumGrantAll">0</b> zł</span>
      <span class="pill admin-only">Limit pakietu: <b id="sumCapProg">—</b> zł <span id="capBadge" class="cap-prog hidden">LIMIT (pakiet)</span></span>
      <span class="pill admin-only">Dotacja po limicie: <b id="sumGrantCapped">0</b> zł</span>
      <span class="pill admin-only">Nadwyżka ponad limit: <b id="sumOverCap">0</b> zł</span>
      <span class="pill">Suma dopłaty (brutto): <b id="sumCopayAll">0</b> zł</span>
      <span class="pill">Min. wymagany wydatek (netto): <b id="sumNeedAll">—</b> zł</span>
    </div>

    <div style="margin-top:8px">
      <span id="noteOver" class="chip danger hidden admin-only">Uwaga: wykryto nadwyżkę ponad limit pakietu – powiększa dopłatę klienta.</span>
      <span id="noteNoPack" class="chip warn hidden admin-only">Brak limitu pakietowego dla wybranej kombinacji (działają tylko limity pojedyncze).</span>
    </div>

    <div class="toolbar">
      <button id="btnSave" class="ghost admin-only" type="button">Zapisz</button>
      <button id="btnLoad" class="ghost admin-only" type="button">Wczytaj</button>
      <button id="btnCSVAll" class="ghost admin-only" type="button">CSV (łączny)</button>

      <button id="btnAutoNeedMain" class="ghost admin-only" type="button">Auto: 100% limitu (główne)</button>
      <button id="btnAutoNeedEnv" class="ghost admin-only" type="button">Auto: 100% stawki (ocieplenie)</button>
      <button id="btnPresetAll" class="ghost admin-only" type="button">Wyczyść wybory</button>

      <!-- Druk -->
      <button id="btnPrintClient" class="ok" type="button">🖨 Drukuj dla klienta</button>
      <button id="btnPrintSellerFull" class="ghost admin-only" type="button">🖨 Druk – sprzedawca (szczegółowy)</button>
      <button id="btnPrintSellerShort" class="ghost admin-only" type="button">🖨 Druk – sprzedawca (skrócony)</button>
      <button id="btnPrintSellerTech" class="ghost admin-only" type="button">🖨 Druk – sprzedawca (techniczny)</button>

      <!-- Wysyłka -->
      <button id="btnSendClient" class="ghost" type="button">✉ Wyślij e‑mailem (klient)</button>
      <button id="btnSendFull" class="ghost admin-only" type="button">✉ Wyślij e‑mailem (pełny)</button>
    </div>

    <div class="subnote admin-only">Wysyłka: na telefonach (Chrome/Android) plik udostępni się bezpośrednio; na desktopie zostanie pobrany i otworzy się okno poczty (należy dołączyć plik ręcznie).</div>

    <div class="admin-only" style="margin-top:10px">
      <label for="notes">Notatki sprzedawcy (zapisują się lokalnie razem ze stanem)</label>
      <textarea id="notes" placeholder="np. nazwisko klienta, telefon, adres inwestycji, uwagi…"></textarea>
    </div>
  </section>

  <!-- ŹRÓDŁO CIEPŁA -->
  <section id="tab-main" role="tabpanel" aria-labelledby="tabbtn-main">
    <section class="panel">
      <div class="muted" style="margin-bottom:8px">
        Dotacja = <i>min(koszt NETTO × % , limit dla poziomu)</i>. Dopuszczalne tylko <b>jedno źródło ciepła</b>.
      </div>
      <div class="right admin-only" style="margin-bottom:6px">
        <button id="btnPresetMain" class="ghost" type="button">Przywróć domyślne (główne)</button>
        <button id="btnCSVMain" class="ghost" type="button">CSV (główne)</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Wybierz</th>
              <th>Komponent / Wariant</th>
              <th class="num">Koszt (Twoja kwota)</th>
              <th class="num hide-sm admin-only">Limit (aktywny)</th>
              <th class="num hide-sm admin-only">Min. wydatek (netto)</th>
              <th class="num">Dotacja</th>
              <th class="num hide-sm admin-only">Koszt brutto</th>
              <th class="num">Dopłata (brutto)</th>
            </tr>
          </thead>
          <tbody id="tbodyMain"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="num hide-sm admin-only"><b>SUMA (główne)</b></td>
              <td class="num" id="sumMain">0</td>
              <td class="num hide-sm admin-only" id="sumMainGross">0</td>
              <td class="num" id="sumMainCopay">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>

  <!-- OCIEPLENIE / STOLARKA -->
  <section id="tab-env" class="hidden" role="tabpanel" aria-labelledby="tabbtn-env">
    <section class="panel">
      <div class="muted">Dotacja = <i>min( koszt NETTO × % , pow_m2 × stawka_dotacji_NETTO_na_m2 )</i>. Ceny brutto liczone z wybranego VAT.</div>
    </section>
    <section class="panel">
      <div class="right admin-only" style="margin-bottom:6px">
        <button id="btnPresetEnv" class="ghost" type="button">Przywróć domyślne (ocieplenie)</button>
        <button id="btnCSVEnv" class="ghost" type="button">CSV (ocieplenie)</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Wybierz</th>
              <th>Pozycja</th>
              <th class="num">Pow. [m²]</th>
              <th class="num">Twoja cena / m² (NETTO/BRUTTO)</th>
              <th class="num admin-only">Maks. dotacja / m² (NETTO)</th>
              <th class="num">Koszt NETTO</th>
              <th class="num admin-only">Limit z m²</th>
              <th class="num">Dotacja</th>
              <th class="num hide-sm admin-only">Koszt BRUTTO</th>
              <th class="num">Dopłata (brutto)</th>
            </tr>
          </thead>
          <tbody id="tbodyEnv"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="num hide-sm admin-only"><b>SUMA (ocieplenie/stolarka)</b></td>
              <td class="num" id="sumEnvGrant">0</td>
              <td class="num hide-sm admin-only" id="sumEnvGross">0</td>
              <td class="num" id="sumEnvCopay">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const q =(s)=>document.querySelector(s);
const qa=(s)=>Array.from(document.querySelectorAll(s));
const INT=new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmt=(n)=> (isFinite(n)? INT.format(Math.round(n)) : '—');
const toNum=(v)=>{
  if (typeof v!=='string') return Number(v)||0;
  let s=v.replace(/\u00A0/g,' ').replace(/\s+/g,'').replace(/\./g,'').replace(',', '.');
  const n=parseFloat(s); return isFinite(n)? n : 0;
};
const debounce=(fn,ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
const nowStr=()=>new Date().toLocaleString('pl-PL');

/* ===== VAT (globalny) ===== */
let VAT=0.08;
q('#vatSel').addEventListener('change', ()=>{ VAT=Number(q('#vatSel').value)||0.08; recomputeAllRows(); updateAggregates(); saveAll(); });

/* ===== limity pakietowe ===== */
const PACK_CAPS={
  GRUNT:{ EU_BELOW_80:{P:34840,M:60970,T:null}, EU_80_140:{P:54040,M:94570,T:null}, EU_ABOVE_140:{P:68040,M:119070,T:170100} },
  PW_PLUS:{ EU_BELOW_80:{P:22920,M:40110,T:null}, EU_80_140:{P:42120,M:73710,T:null}, EU_ABOVE_140:{P:56120,M:98210,T:140300} },
  BIOMASS:{ EU_BELOW_80:{P:17040,M:29820,T:null}, EU_80_140:{P:36240,M:63420,T:null}, EU_ABOVE_140:{P:50240,M:87920,T:125600} }
};

/* ===== stawki/m2 (NETTO) ===== */
const RATES_M2={
  sciany:{P:180,M:210,T:250},
  strop:{P:80,M:140,T:200},
  podloga:{P:80,M:100,T:150},
  okna:{P:650,M:1050,T:1500},
  drzwi:{P:2000,M:2500,T:3000},
  bramy:{P:600,M:1050,T:1500}
};

/* ===== login (UI; nie jest zabezpieczeniem serwerowym) — poprawiony ===== */
(function(){
  const okUser='arkon';       // akceptujemy różną wielkość liter
  const okPass='arkon2025';
