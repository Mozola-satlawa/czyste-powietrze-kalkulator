<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kalkulator dotacji – Czyste Powietrze (2025)</title>
<meta name="description" content="Kalkulator dotacji programu Czyste Powietrze 2025: poziomy dofinansowania, limity, CSV/JSON, druk/PDF.">
<link rel="icon" href="/favicon.ico">
<style>
  :root{
    --bg:#0b1020; --panel:#121a34; --panel-2:#172142; --ink:#e8edff; --muted:#aeb8da;
    --accent:#4cc9f0; --accent-2:#80ffdb; --warn:#ffd166; --ok:#95d5b2; --bad:#ef476f; --grid:#243059;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,#0a0f1e, #0c1230 60%, #0a0f1e); color:var(--ink); font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px; margin:auto; padding:28px 18px 96px}
  header{display:flex; gap:14px; align-items:center; margin-bottom:18px}
  .logo{width:46px; height:46px; border-radius:10px; display:grid; place-items:center; background:radial-gradient(120% 120% at 20% 20%, #1f2a55, #0b1333); border:1px solid #1f2a55; box-shadow:0 6px 24px #0006, inset 0 0 0 1px #2a3870; color:var(--accent); font-weight:700}
  h1{font-size:20px; margin:0}
  .muted{color:var(--muted); font-size:13px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 16px}
  .tab-btn{background:linear-gradient(180deg,#2b3a77,#26336c); border:1px solid #3a4ca3; color:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
  .tab-btn.active{background:#1b2550; border-color:#67a1ff; box-shadow:0 0 0 2px #67a1ff44}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid #1c2750; border-radius:14px; padding:16px; box-shadow:0 10px 30px #0006; margin-bottom:16px}
  .grid{display:grid; gap:12px}
  @media (min-width:860px){ .grid.cols-3{grid-template-columns: 1.2fr 1fr 1fr} .grid.cols-2{grid-template-columns: 1fr 1fr} }
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input,select,button,textarea{font:600 15px/1.2 system-ui,Segoe UI,Roboto,Arial; color:var(--ink)}
  input,select,textarea{width:100%; background:#0d1530; border:1px solid #28356c; border-radius:10px; padding:12px; outline:none; transition:border .2s, box-shadow .2s}
  input:focus,select:focus,textarea:focus{border-color:#3b4fa0; box-shadow:0 0 0 3px #3b4fa033}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:8px 12px; border-radius:999px; background:#0d1530; border:1px dashed #2b3a77; color:var(--muted); font-size:13px}
  .stat{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap}
  button{background:linear-gradient(180deg,#2b3a77,#26336c); border:1px solid #3a4ca3; color:#fff; border-radius:12px; padding:12px 14px; cursor:pointer; box-shadow:0 6px 18px #0008, inset 0 0 0 1px #4d63c7}
  button.ghost{background:transparent; border:1px dashed #3a4ca3}
  button.warn{background:linear-gradient(180deg,#67521e,#5a491e); border-color:#b08b2e}
  button.ok{background:linear-gradient(180deg,#1c5c3a,#184f32); border-color:#2b8a57}
  table{width:100%; border-collapse:separate; border-spacing:0; color:var(--ink)}
  th,td{padding:12px; text-align:left; border-bottom:1px solid var(--grid)}
  thead th{position:sticky; top:0; background:#0f1840; z-index:1; font-size:13px; color:#d6ddff}
  tbody tr:hover td{background:#0e1635}
  tfoot td{font-weight:800}
  .num{text-align:right}
  .chip{display:inline-block; padding:.3rem .6rem; border-radius:999px; font-weight:800; font-size:13px}
  .chip.basic{background:#23305f; border:1px solid #3650d2; color:#bcd0ff}
  .chip.mid{background:#22463a; border:1px solid #2fa672; color:#baf3d0}
  .chip.top{background:#3a2c1a; border:1px solid #e0b34d; color:#ffe7a8}
  .chip.none{background:#3b1d27; border:1px solid #ad3e5a; color:#ffd0dc}
  .small{font-size:12px}
  .hr{height:1px; background:var(--grid); margin:10px 0 2px}
  .hidden{display:none}
  @media print{ body{background:#fff; color:#000} .panel{box-shadow:none; border:1px solid #ccc; background:#fff} button,.toolbar,.tabs{display:none !important} .logo{border:0; box-shadow:none} .chip{border:1px solid #000} }
  noscript{display:block; background:#5b1a2b; color:#fff; padding:10px 12px; border-radius:10px; margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true">CP</div>
    <div>
      <h1>Kalkulator dotacji • Czyste Powietrze 2025</h1>
      <div class="muted">Dwie zakładki: kalkulator główny oraz ocieplenie/stolarka z progiem EU ≤/> 140 kWh/m²·rok. Zapis lokalny, eksport CSV/JSON, druk/PDF.</div>
    </div>
  </header>

  <noscript>Ten kalkulator wymaga włączonego JavaScript.</noscript>

  <div class="tabs" role="tablist" aria-label="Tryby kalkulatora">
    <button class="tab-btn active" data-tab="main" role="tab" aria-selected="true" aria-controls="tab-main">Kalkulator główny</button>
    <button class="tab-btn" data-tab="envelope" role="tab" aria-selected="false" aria-controls="tab-envelope">Ocieplenie i stolarka</button>
  </div>

  <!-- TAB: MAIN -->
  <section id="tab-main" role="tabpanel">
    <section class="panel">
      <div class="grid cols-3">
        <div>
          <label for="typ">Typ gospodarstwa</label>
          <select id="typ"><option value="">— wybierz —</option><option>JEDNO</option><option>WIELO</option></select>
        </div>
        <div>
          <label for="osoby">Liczba osób w gospodarstwie</label>
          <input id="osoby" type="number" min="1" step="1" placeholder="np. 3" />
        </div>
        <div>
          <label for="doch_mies">Miesięczny dochód na osobę [zł]</label>
          <input id="doch_mies" inputmode="decimal" placeholder="np. 2100" />
        </div>
        <div>
          <label for="doch_roczny">Roczny dochód wnioskodawcy [zł]</label>
          <input id="doch_roczny" inputmode="decimal" placeholder="np. 120000" />
        </div>
        <div>
          <label for="swiadczenia">Pobierasz świadczenia (MOPS/GOPS itp.)</label>
          <select id="swiadczenia"><option value="">— wybierz —</option><option>TAK</option><option>NIE</option></select>
        </div>
        <div class="stat">
          <span class="pill">Poziom:&nbsp;<span id="poziom_chip" class="value chip none" aria-live="polite">—</span></span>
          <span class="pill">Procent:&nbsp;<span id="procent" class="value" aria-live="polite">—</span></span>
        </div>
      </div>
      <div class="hr"></div>
      <div class="toolbar">
        <button class="ok" id="btnSave">Zapisz</button>
        <button class="ghost" id="btnLoad">Wczytaj</button>
        <button class="ghost" id="btnReset">Wyczyść</button>
        <button class="warn" id="btnPrint">Drukuj / PDF</button>
        <button id="btnExportMain" class="ghost">Eksport JSON (główna)</button>
        <label class="tab-btn ghost" style="margin:0">Import JSON
          <input type="file" id="fileImportMain" accept="application/json" style="display:none">
        </label>
        <button id="btnExportMainCSV" class="ghost">Eksport CSV (główna)</button>
        <button id="btnExportAllCSV" class="ghost">Eksport CSV (łączny)</button>
        <button id="btnCopySummary" class="ghost">Kopiuj podsumowanie</button>
      </div>
      <div class="small muted" style="margin-top:6px">Kalkulator pomocniczy – zawsze sprawdź aktualne dokumenty programu.</div>
    </section>

    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <div class="muted">Wydatki i limity (dotacja = min(koszt × %, limit dla poziomu))</div>
        <div class="toolbar">
          <button id="btnAdd">+ Dodaj pozycję</button>
          <button id="btnPreset">Przywróć domyślne</button>
        </div>
      </div>
      <div style="overflow:auto; margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:240px">Zakres</th>
              <th class="num">Koszt [zł]</th>
              <th class="num">Limit – podstawowy</th>
              <th class="num">Limit – podwyższony</th>
              <th class="num">Limit – najwyższy</th>
              <th class="num">Dotacja [zł]</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="num">SUMA DOTACJI</td>
              <td class="num" id="suma" aria-live="polite">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>

  <!-- TAB: ENVELOPE -->
  <section id="tab-envelope" class="hidden" role="tabpanel">
    <section class="panel">
      <div class="grid cols-2">
        <div>
          <label for="euThreshold">Próg zapotrzebowania EU [kWh/m²·rok]</label>
          <select id="euThreshold"><option value="LE">EU ≤ 140</option><option value="GT">EU &gt; 140</option></select>
        </div>
        <div class="stat"><span class="pill">Bieżący próg:&nbsp;<span id="euLabel" class="value">EU ≤ 140</span></span></div>
      </div>
      <div class="hr"></div>
      <div class="toolbar">
        <button id="btnAddEnv">+ Dodaj pozycję</button>
        <button id="btnPresetEnv" class="ghost">Przywróć domyślne</button>
        <button id="btnExportEnv" class="ghost">Eksport JSON (ocieplenie)</button>
        <label class="tab-btn ghost" style="margin:0">Import JSON
          <input type="file" id="fileImportEnv" accept="application/json" style="display:none">
        </label>
        <button id="btnExportEnvCSV" class="ghost">Eksport CSV (ocieplenie)</button>
      </div>
      <div class="small muted" style="margin-top:6px">
        Wprowadź koszt i limity dla obu progów EU. Dotacja = min(koszt × % Twojego poziomu, limit dla wybranego progu).
      </div>
    </section>

    <section class="panel">
      <div style="overflow:auto">
        <table id="tblEnv">
          <thead>
            <tr>
              <th style="min-width:200px">Pozycja (ściana/dach/okno…)</th>
              <th class="num">Koszt [zł]</th>
              <th class="num">LE: Limit Podst.</th>
              <th class="num">LE: Limit Podwyższ.</th>
              <th class="num">LE: Limit Najwyższy</th>
              <th class="num">GT: Limit Podst.</th>
              <th class="num">GT: Limit Podwyższ.</th>
              <th class="num">GT: Limit Najwyższy</th>
              <th class="num">Dotacja [zł]</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbodyEnv"></tbody>
          <tfoot>
            <tr>
              <td colspan="8" class="num">SUMA DOTACJI (ocieplenie/stolarka)</td>
              <td class="num" id="sumaEnv" aria-live="polite">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </section>
</div>

<script>
console.log('CP kalkulator: JS działa ✔');

/* ========= helpers ========= */
const q  = s => document.querySelector(s);
const qa = s => Array.from(document.querySelectorAll(s));
const fmt = n => (isFinite(n) ? new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0}).format(n) : '—');
const toNum = v => {
  if (typeof v !== 'string') return Number(v)||0;
  v = v.replace(/\s+/g,'').replace(/\./g,'').replace(',', '.');
  const num = parseFloat(v);
  return isFinite(num) ? num : 0;
};
function toast(msg, error=false){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style,{
    position:'fixed', right:'16px', bottom:'16px',
    background: error ? '#9b2c2c' : '#234b2f',
    border:'1px solid ' + (error ? '#ff8e9e' : '#4caf79'),
    color:'#fff', padding:'10px 12px', borderRadius:'10px',
    boxShadow:'0 8px 22px #0008', zIndex:9999, opacity:'0',
    transition:'opacity .2s, transform .2s', transform:'translateY(6px)'
  });
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateY(0)';});
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; setTimeout(()=>t.remove(),200); }, 1800);
}
function debounce(func, wait = 200){
  let timeout; return function(...args){ clearTimeout(timeout); timeout=setTimeout(()=>func.apply(this,args),wait); };
}
const uuid = () => (window.crypto?.randomUUID?.() || ('id-' + Math.random().toString(36).slice(2)));

/* ========= poziomy 2025 (skrót) ========= */
function calcLevel({typ, mies, roczny, swiadczenia}) {
  const t = (typ||'').toUpperCase();
  const ben = (swiadczenia||'').toUpperCase()==='TAK';
  const m = toNum(mies), r = toNum(roczny);
  if (ben || (t==='JEDNO' && m<=1800) || (t==='WIELO' && m<=1300)) return {name:'NAJWYŻSZY', pct:1,   chip:'top'};
  if ((t==='JEDNO' && m<=3150) || (t==='WIELO' && m<=2250))         return {name:'PODWYŻSZONY', pct:0.7, chip:'mid'};
  if (r>0 && r<=135000)                                             return {name:'PODSTAWOWY', pct:0.4, chip:'basic'};
  return {name:'BRAK', pct:0, chip:'none'};
}

/* ========= tabs ========= */
qa('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    qa('.tab-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
    btn.classList.add('active'); btn.setAttribute('aria-selected','true');
    const tab = btn.dataset.tab;
    q('#tab-main').classList.toggle('hidden', tab!=='main');
    q('#tab-envelope').classList.toggle('hidden', tab!=='envelope');
  });
});

/* ========= MAIN ========= */
let rows = [];
const PRESET = [
  {n:'Podłączenie do sieci ciepłowniczej', c:0, l1:8900,  l2:15575, l3:22250},
  {n:'Pompa ciepła powietrze/woda',       c:0, l1:12600, l2:22000, l3:31500},
  {n:'PC pow./woda (wyższa klasa)',       c:0, l1:14080, l2:24640, l3:35200},
  {n:'Pompa ciepła powietrze/powietrze',  c:0, l1:4480,  l2:7840,  l3:11200},
  {n:'Gruntowa pompa ciepła (wyższa kl.)',c:0, l1:18000, l2:31500, l3:45000},
  {n:'Dolne źródło (odwierty)',           c:0, l1:8000,  l2:14000, l3:20000},
  {n:'Fotowoltaika (PV)',                 c:0, l1:6000,  l2:9000,  l3:15000},
  {n:'Audyt energetyczny',                c:0, l1:480,   l2:840,   l3:1200},
];
const renderMainDebounced = debounce(renderMain, 200);

function computeDotacjaMain(r, level){
  const koszt = toNum(r.c), pct = level.pct;
  const lim = level.name==='PODSTAWOWY' ? toNum(r.l1) : level.name==='PODWYŻSZONY' ? toNum(r.l2) : level.name==='NAJWYŻSZY' ? toNum(r.l3) : 0;
  return Math.min(koszt * pct, lim);
}
function addRow(d={n:'Nowa pozycja', c:0, l1:0, l2:0, l3:0}){ rows.push({...d, id:uuid()}); renderMain(); saveMain(false); }
function delRow(id){ rows = rows.filter(r=>r.id!==id); renderMain(); saveMain(false); }

function renderMain(){
  const level = calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });
  const chip = q('#poziom_chip'); chip.textContent = level.name; chip.className = 'value chip '+(level.chip||'none');
  q('#procent').textContent = level.pct ? (level.pct*100).toFixed(0)+'%' : '—';

  const tb = q('#tbody'); tb.innerHTML = '';
  let suma = 0;
  rows.forEach(r=>{
    const tr = document.createElement('tr');

    const tdN = document.createElement('td'); 
    const iN = document.createElement('input'); iN.value=r.n; 
    iN.oninput=e=>{r.n=e.target.value; saveMain(false)};
    tdN.append(iN);

    const tdC = document.createElement('td'); tdC.className='num';
    const iC=document.createElement('input'); iC.className='num'; iC.value=r.c;
    iC.oninput=e=>{r.c=e.target.value; renderMainDebounced(); saveMain(false)};
    tdC.append(iC);

    const tdl1=document.createElement('td'); tdl1.className='num';
    const inpl1=document.createElement('input'); inpl1.className='num'; inpl1.value=r.l1;
    inpl1.oninput=e=>{r.l1=e.target.value; renderMainDebounced(); saveMain(false)};
    tdl1.append(inpl1);

    const tdl2=document.createElement('td'); tdl2.className='num';
    const inpl2=document.createElement('input'); inpl2.className='num'; inpl2.value=r.l2;
    inpl2.oninput=e=>{r.l2=e.target.value; renderMainDebounced(); saveMain(false)};
    tdl2.append(inpl2);

    const tdl3=document.createElement('td'); tdl3.className='num';
    const inpl3=document.createElement('input'); inpl3.className='num'; inpl3.value=r.l3;
    inpl3.oninput=e=>{r.l3=e.target.value; renderMainDebounced(); saveMain(false)};
    tdl3.append(inpl3);

    const tdD=document.createElement('td'); tdD.className='num';
    const kwota=computeDotacjaMain(r,level); tdD.textContent=fmt(kwota);

    const tdA=document.createElement('td'); 
    const btn=document.createElement('button'); btn.className='ghost'; btn.textContent='Usuń'; btn.onclick=()=>delRow(r.id); 
    tdA.append(btn);

    tr.append(tdN,tdC,tdl1,tdl2,tdl3,tdD,tdA); 
    tb.append(tr); 
    suma+=kwota;
  });
  q('#suma').textContent = fmt(suma);
}

function saveMain(show=true){
  const payload = { typ:q('#typ').value, osoby:q('#osoby').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiad:q('#swiadczenia').value, rows };
  localStorage.setItem('cp2025_main', JSON.stringify(payload)); if(show) toast('Zapisano (główna).');
}
function loadMain(){
  const raw = localStorage.getItem('cp2025_main'); 
  if(!raw){ toast('Brak zapisu (główna).'); return; }
  try{ 
    const p = JSON.parse(raw);
    q('#typ').value         = p.typ   ?? '';
    q('#osoby').value       = p.osoby ?? '';
    q('#doch_mies').value   = p.mies  ?? '';
    q('#doch_roczny').value = p.roczny?? '';
    q('#swiadczenia').value = p.swiad ?? '';
    rows = Array.isArray(p.rows)? p.rows : []; 
    renderMain(); 
    toast('Wczytano (główna).');
  }catch{ toast('Nie udało się wczytać (główna).', true); }
}
function resetMain(){ localStorage.removeItem('cp2025_main'); q('#typ').value=''; q('#osoby').value=''; q('#doch_mies').value=''; q('#doch_roczny').value=''; q('#swiadczenia').value=''; presetMain(); renderMain(); }
function presetMain(){ rows=[]; PRESET.forEach(p=>rows.push({...p, id:uuid()})); }

/* ========= ENVELOPE ========= */
let envRows = [];
const PRESET_ENV = [
  {n:'Ściany zewnętrzne', c:0, le1:12000, le2:21000, le3:30000, gt1:14000, gt2:24500, gt3:35000},
  {n:'Dach / stropodach', c:0, le1:10000, le2:17500, le3:25000, gt1:12000, gt2:21000, gt3:30000},
  {n:'Podłoga na gruncie', c:0, le1:5000,  le2:8750,  le3:12500, gt1:6000,  gt2:10500, gt3:15000},
  {n:'Okna',               c:0, le1:6000,  le2:10500, le3:15000, gt1:7000,  gt2:12250, gt3:17500},
  {n:'Drzwi zewnętrzne',   c:0, le1:2500,  le2:4375,  le3:6250,  gt1:3000,  gt2:5250,  gt3:7500},
];
const renderEnvDebounced = debounce(renderEnv, 200);

function currentLimitSet(r, level, mode){
  const l1 = mode==='LE' ? r.le1 : r.gt1;
  const l2 = mode==='LE' ? r.le2 : r.gt2;
  const l3 = mode==='LE' ? r.le3 : r.gt3;
  return level.name==='PODSTAWOWY' ? toNum(l1) : level.name==='PODWYŻSZONY' ? toNum(l2) : level.name==='NAJWYŻSZY' ? toNum(l3) : 0;
}
function computeDotacjaEnv(r, level, mode){
  const koszt = toNum(r.c), pct = level.pct, lim = currentLimitSet(r, level, mode);
  return Math.min(koszt * pct, lim);
}
function addEnvRow(d={n:'Nowa pozycja', c:0, le1:0, le2:0, le3:0, gt1:0, gt2:0, gt3:0}){ envRows.push({...d, id:uuid()}); renderEnv(); saveEnv(false); }
function delEnvRow(id){ envRows = envRows.filter(r=>r.id!==id); renderEnv(); saveEnv(false); }

function renderEnv(){
  const mode = q('#euThreshold').value; 
  q('#euLabel').textContent = mode==='LE' ? 'EU ≤ 140' : 'EU > 140';
  const level = calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });

  const tb = q('#tbodyEnv'); tb.innerHTML=''; let suma=0;
  envRows.forEach(r=>{
    const tr=document.createElement('tr');

    const tdN=document.createElement('td'); 
    const iN=document.createElement('input'); iN.value=r.n; 
    iN.oninput=e=>{r.n=e.target.value; saveEnv(false)};
    tdN.append(iN);

    const tdC=document.createElement('td'); tdC.className='num'; 
    const iC=document.createElement('input'); iC.className='num'; iC.value=r.c; 
    iC.oninput=e=>{r.c=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdC.append(iC);

    const tdLE1=document.createElement('td'); tdLE1.className='num'; 
    const iLE1=document.createElement('input'); iLE1.className='num'; iLE1.value=r.le1; 
    iLE1.oninput=e=>{r.le1=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdLE1.append(iLE1);

    const tdLE2=document.createElement('td'); tdLE2.className='num'; 
    const iLE2=document.createElement('input'); iLE2.className='num'; iLE2.value=r.le2; 
    iLE2.oninput=e=>{r.le2=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdLE2.append(iLE2);

    const tdLE3=document.createElement('td'); tdLE3.className='num'; 
    const iLE3=document.createElement('input'); iLE3.className='num'; iLE3.value=r.le3; 
    iLE3.oninput=e=>{r.le3=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdLE3.append(iLE3);

    const tdGT1=document.createElement('td'); tdGT1.className='num'; 
    const iGT1=document.createElement('input'); iGT1.className='num'; iGT1.value=r.gt1; 
    iGT1.oninput=e=>{r.gt1=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdGT1.append(iGT1);

    const tdGT2=document.createElement('td'); tdGT2.className='num'; 
    const iGT2=document.createElement('input'); iGT2.className='num'; iGT2.value=r.gt2; 
    iGT2.oninput=e=>{r.gt2=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdGT2.append(iGT2);

    const tdGT3=document.createElement('td'); tdGT3.className='num'; 
    const iGT3=document.createElement('input'); iGT3.className='num'; iGT3.value=r.gt3; 
    iGT3.oninput=e=>{r.gt3=e.target.value; renderEnvDebounced(); saveEnv(false)}; 
    tdGT3.append(iGT3);

    const tdD=document.createElement('td'); tdD.className='num'; 
    const kwota=computeDotacjaEnv(r, level, mode); tdD.textContent=fmt(kwota);

    const tdA=document.createElement('td'); 
    const btn=document.createElement('button'); btn.className='ghost'; btn.textContent='Usuń'; btn.onclick=()=>delEnvRow(r.id); 
    tdA.append(btn);

    tr.append(tdN,tdC,tdLE1,tdLE2,tdLE3,tdGT1,tdGT2,tdGT3,tdD,tdA); 
    tb.append(tr); 
    suma+=kwota;
  });
  q('#sumaEnv').textContent = fmt(suma);
}

function saveEnv(show=true){ localStorage.setItem('cp2025_env', JSON.stringify({mode:q('#euThreshold').value, envRows})); if(show) toast('Zapisano (ocieplenie/stolarka).'); }
function loadEnv(){
  const raw = localStorage.getItem('cp2025_env'); 
  if(!raw){ toast('Brak zapisu (ocieplenie).'); return; }
  try{ 
    const p = JSON.parse(raw); 
    q('#euThreshold').value = p.mode || 'LE'; 
    envRows = Array.isArray(p.envRows)? p.envRows : []; 
    renderEnv(); 
    toast('Wczytano (ocieplenie).'); 
  } catch { toast('Nie udało się wczytać (ocieplenie).', true); }
}
function resetEnv(){ localStorage.removeItem('cp2025_env'); q('#euThreshold').value='LE'; presetEnv(); renderEnv(); }
function presetEnv(){ envRows=[]; PRESET_ENV.forEach(p=>envRows.push({...p, id:uuid()})); }

/* ========= JSON / CSV ========= */
q('#btnExportMain').addEventListener('click', ()=>{
  saveMain(false);
  const blob=new Blob([localStorage.getItem('cp2025_main')||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cp2025_main.json'; a.click();
});
q('#fileImportMain').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ localStorage.setItem('cp2025_main', r.result); loadMain(); }catch{ toast('Import nieudany', true);} };
  r.readAsText(f);
});
q('#btnExportEnv').addEventListener('click', ()=>{
  saveEnv(false);
  const blob=new Blob([localStorage.getItem('cp2025_env')||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cp2025_ocieplenie.json'; a.click();
});
q('#fileImportEnv').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=()=>{ try{ localStorage.setItem('cp2025_env', r.result); loadEnv(); }catch{ toast('Import nieudany', true);} };
  r.readAsText(f);
});

function csvEscape(v){
  const s = String(v ?? '');
  // jeśli są znaki specjalne, otocz w cudzysłowy i podwajaj istniejące cudzysłowy
  return /[",;\n]/.test(s) ? "${s.replace(/"/g, '""')}" : s;
}

function downloadCSV(name, rowsOut){
  const csv  = rowsOut.map(r => r.map(csvEscape).join(';')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = name.endsWith('.csv') ? name : ${name}.csv;
  a.click();
  URL.revokeObjectURL(a.href);
}
}
function exportMainCSV(){
  const level = calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });
  const out=[['Zakres','Koszt [zł]','Limit PODST.','Limit PODWYŻSZ.','Limit NAJWYŻSZY','Dotacja [zł]']]; let suma=0;
  rows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim = level.name==='PODSTAWOWY'?toNum(r.l1):level.name==='PODWYŻSZONY'?toNum(r.l2):level.name==='NAJWYŻSZY'?toNum(r.l3):0;
    const dot=Math.min(koszt*level.pct, lim); suma+=dot;
    out.push([r.n,koszt,r.l1,r.l2,r.l3,Math.round(dot)]);
  });
  out.push(['SUMA','','','','',Math.round(suma)]);
  downloadCSV('cp2025_glowna', out);
}
function exportEnvCSV(){
  const mode=q('#euThreshold').value, level=calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });
  const out=[['Pozycja','Koszt [zł]','LE: Limit Podst.','LE: Limit Podwyższ.','LE: Limit Najwyższy','GT: Limit Podst.','GT: Limit Podwyższ.','GT: Limit Najwyższy','Dotacja [zł] (tryb '+(mode==='LE'?'EU ≤ 140':'EU > 140')+')']]; let suma=0;
  envRows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim=currentLimitSet(r,level,mode);
    const dot=Math.min(koszt*level.pct,lim); suma+=dot;
    out.push([r.n,koszt,r.le1,r.le2,r.le3,r.gt1,r.gt2,r.gt3,Math.round(dot)]);
  });
  out.push(['SUMA','','','','','','','',Math.round(suma)]);
  downloadCSV('cp2025_ocieplenie', out);
}
function exportAllCSV(){
  const level=calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value }); const mode=q('#euThreshold').value;
  const out=[];
  out.push(['Metryczka']);
  out.push(['Typ gospodarstwa', q('#typ').value]);
  out.push(['Osób', q('#osoby').value]);
  out.push(['Dochód/os (mies.)', q('#doch_mies').value]);
  out.push(['Dochód roczny', q('#doch_roczny').value]);
  out.push(['Świadczenia', q('#swiadczenia').value]);
  out.push(['Poziom', level.name]);
  out.push(['Procent', (level.pct*100||0)+'%']);
  out.push(['']);

  out.push(['Kalkulator główny']);
  out.push(['Zakres','Koszt [zł]','Limit PODST.','Limit PODWYŻSZ.','Limit NAJWYŻSZY','Dotacja [zł]']);
  let sumaMain=0;
  rows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim=level.name==='PODSTAWOWY'?toNum(r.l1):level.name==='PODWYŻSZONY'?toNum(r.l2):level.name==='NAJWYŻSZY'?toNum(r.l3):0;
    const dot=Math.min(koszt*level.pct,lim); sumaMain+=dot;
    out.push([r.n,koszt,r.l1,r.l2,r.l3,Math.round(dot)]);
  });
  out.push(['SUMA','','','','',Math.round(sumaMain)]);
  out.push(['']);

  out.push(['Ocieplenie i stolarka (tryb: '+(mode==='LE'?'EU ≤ 140':'EU > 140')+')']);
  out.push(['Pozycja','Koszt [zł]','LE: Limit Podst.','LE: Limit Podwyższ.','LE: Limit Najwyższy','GT: Limit Podst.','GT: Limit Podwyższ.','GT: Limit Najwyższy','Dotacja [zł]']);
  let sumaEnv=0;
  envRows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim=currentLimitSet(r,level,mode);
    const dot=Math.min(koszt*level.pct,lim); sumaEnv+=dot;
    out.push([r.n,koszt,r.le1,r.le2,r.le3,r.gt1,r.gt2,r.gt3,Math.round(dot)]);
  });
  out.push(['SUMA','','','','','','','',Math.round(sumaEnv)]);
  downloadCSV('cp2025_laczny', out);
}

/* ========= copy summary ========= */
function copySummary(){
  const level=calcLevel({ typ:q('#typ').value, mies:q('#doch_mies').value, roczny:q('#doch_roczny').value, swiadczenia:q('#swiadczenia').value });

  let sumaMain=0; rows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim=level.name==='PODSTAWOWY'?toNum(r.l1):level.name==='PODWYŻSZONY'?toNum(r.l2):level.name==='NAJWYŻSZY'?toNum(r.l3):0;
    const dot=Math.min(koszt*level.pct,lim); sumaMain+=dot;
  });

  const mode=q('#euThreshold').value; let sumaEnv=0; envRows.forEach(r=>{
    const koszt=toNum(r.c);
    const lim=currentLimitSet(r,level,mode);
    const dot=Math.min(koszt*level.pct,lim); sumaEnv+=dot;
  });

  const txt = `Poziom: ${level.name} (${(level.pct*100||0)}%)
Gospodarstwo: ${q('#typ').value||'-'}, osób: ${q('#osoby').value||'-'}
Dochód/os (mies.): ${q('#doch_mies').value||'-'} | Dochód roczny: ${q('#doch_roczny').value||'-'} | Świadczenia: ${q('#swiadczenia').value||'-'}

Suma dotacji (główna): ${Math.round(sumaMain)} zł
Suma dotacji (ocieplenie): ${Math.round(sumaEnv)} zł
Razem: ${Math.round(sumaMain + sumaEnv)} zł
`;
  navigator.clipboard.writeText(txt)
    .then(()=>toast('Podsumowanie skopiowane.'))
    .catch(()=>toast('Nie udało się skopiować.', true));
}

/* ========= events ========= */
['#typ','#osoby','#doch_mies','#doch_roczny','#swiadczenia'].forEach(sel => q(sel).addEventListener('input', ()=>{ renderMain(); renderEnv(); }));
q('#btnAdd').addEventListener('click', ()=>addRow());
q('#btnPreset').addEventListener('click', ()=>{ presetMain(); renderMain(); saveMain(false); });
q('#btnSave').addEventListener('click', ()=>{ saveMain(true); saveEnv(true); });
q('#btnLoad').addEventListener('click', ()=>{ loadMain(); loadEnv(); });
q('#btnReset').addEventListener('click', ()=>{ resetMain(); resetEnv(); });
q('#btnPrint').addEventListener('click', ()=>window.print());
q('#euThreshold').addEventListener('change', ()=>{ renderEnv(); saveEnv(false); });
q('#btnAddEnv').addEventListener('click', ()=>addEnvRow());
q('#btnPresetEnv').addEventListener('click', ()=>{ presetEnv(); renderEnv(); saveEnv(false); });

q('#btnExportMainCSV').addEventListener('click', exportMainCSV);
q('#btnExportEnvCSV').addEventListener('click', exportEnvCSV);
q('#btnExportAllCSV').addEventListener('click', exportAllCSV);
q('#btnCopySummary').addEventListener('click', copySummary);

/* ========= init ========= */
function init(){
  presetMain(); presetEnv();
  if (localStorage.getItem('cp2025_main')) loadMain(); else renderMain();
  if (localStorage.getItem('cp2025_env'))  loadEnv();  else renderEnv();
}
init();
</script>
</body>
</html>

